<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>订单确认</title>
	<link rel="stylesheet" type="text/css" href="{DT_STATIC}skin/mobile/css/shopping.css">
    <script src="{DT_STATIC}skin/mobile/js/swipe.js"></script>
    <script src="{DT_STATIC}skin/mobile/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="{DT_STATIC}file/script/config.js"></script>
    <script type="text/javascript" src="{DT_STATIC}file/script/common.js"></script>
    <script type="text/javascript" src="{DT_STATIC}file/script/page.js"></script>
    <script src="{DT_STATIC}skin/mobile/js/classify.js"></script>      
</head>
<body>
<div class="header">
    <div class="titl">     
        <a href="javascript:void(0)"  onclick="window.history.back()"><img src="{DT_STATIC}skin/mobile/images/fanhui.png"></a>
        <h2>订单确认</h2>
        <div class="navigation" id="box_title">
            <a href="javascript:void(0)"><img src="{DT_STATIC}skin/mobile/images/classify.png"></a>
        </div>    
    </div>
    <div class="nav clearfix" id="box_content">
        <ul class="clearfix">
            <li class="on"><a href="/mobile/index.php"><span><img src="{DT_STATIC}skin/mobile/images/nav.png"></span><em>首页</em></a></li>
            <li class="footer_fl"><a href="/mobile/search.php?action=cate"><span><img src="{DT_STATIC}skin/mobile/images/nav.png"></span><em>分类</em></a></li>
            <li class="tsg"><a href="/mobile/area.php"><span><img src="{DT_STATIC}skin/mobile/images/nav.png"></span><em>特色馆</em></a></li>
            <li class="gwc"><a href="/mobile/cart.php"><span><img src="{DT_STATIC}skin/mobile/images/nav.png"></span><em>购物车</em></a></li>
            <li class="wd"><a href="/mobile/my.php"><span><img src="{DT_STATIC}skin/mobile/images/nav.png"></span><em>我的</em></a></li>
        </ul>
    </div> 
</div>
<form id="purchase-form">
	<input type="hidden" name="ok" value="1"/>
	<input type="hidden" name="moduleid" value="{$moduleid}"/>
	<input type="hidden" name="itemid" value="{$itemid}"/>
	{if $module == 'mall'}
	<input type="hidden" name="s1" value="{$s1}"/>
	<input type="hidden" name="s2" value="{$s3}"/>
	<input type="hidden" name="s3" value="{$s3}"/>
	<input type="hidden" id="fee_start_1" value="{$t[fee_start_1]}"/>
	<input type="hidden" id="fee_step_1" value="{$t[fee_step_1]}"/>
	<input type="hidden" id="fee_start_2" value="{$t[fee_start_2]}"/>
	<input type="hidden" id="fee_step_2" value="{$t[fee_step_2]}"/>
	<input type="hidden" id="fee_start_3" value="{$t[fee_start_3]}"/>
	<input type="hidden" id="fee_step_3" value="{$t[fee_step_3]}"/>
	{/if}
<div class="index orderin">
    <div class="receive clearfix">
    	<div class="receive_lf">
    		<div class="name">收货人：{$addr[truename]}<span>{$addr[mobile]}</span></div>
    		<div class="location">{$addr[address]}</div>
    	</div>
    	<div class="next">
    		<img src="{DT_STATIC}skin/mobile/images/xiala.png">
    	</div>
    </div>
    <div class="detail_in clearfix">
    	<div class="detail">购买详情</div>
    	<div class="detail_2">
    		<div class="detail_img">
    		    <span><img src="{if $t[thumb]}{$t[thumb]}{else}static/img/nopic-60.png{/if}"></span>
    		</div>
    		<div class="detail_ri">
    			<div class="money">￥<span>{$t[price]}</span></div>
    			<div class="qty">x<span id="goods_num">1</span></div>
    		</div>
    	</div>
    </div>
    <div class="scalar clearfix">
    	<div class="scalar_lf">购买数量</div>
    	<div class="scalar_ri">
    		<div class="option">
    			<span class="lessen" onclick="alter('-');">-</span>
    			<input type="tel" size="4" name="number" size="4" value="{$t[minamount]}" id="number">
    			<span class="plus" onclick="alter('+');">+</span>
    		</div>
    	</div>
    </div>
    <div class="postage clearfix">
    	<div class="postage_lf">商品金额：</div>
    	<div class="postage_ri all_price">￥<span id="price">{$t[price]}</span></div>
    </div>
    <div class="postage clearfix">
    	<div class="postage_lf">邮费 :</div>
    	<div class="postage_ri">￥<span id="mail_money">0</span></div>
    </div>
    <div class="memo">
    	<div class="memo_lf">备注 :</div>
    	<textarea name="note" id="note" rows="" wrap="virtual"></textarea>
    </div>
</div>
<div class="footer">
	<div class="foot_lf">应付金额：￥<span id="total">{$t[price]}</span></div>
	<div class="foot_ri" onclick="Dpurchase()"><a href="javascript:void(0)">确认付款</a></div>
</div>
<div id="result"></div>
</form>
<script>
	(function (doc, win) {
	       var docEl = doc.documentElement,
	           resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
	           recalc = function () {
	               var clientWidth = docEl.clientWidth;
	               if (!clientWidth) return;
	               if(clientWidth>=640){
	                   docEl.style.fontSize = '100px';
	               }else{
	                   docEl.style.fontSize = 100 * (clientWidth / 640) + 'px';
	               }
	           };	 
	       if (!doc.addEventListener) return;
	       win.addEventListener(resizeEvt, recalc, false);
	       doc.addEventListener('DOMContentLoaded', recalc, false);
	})(document, window);  
	 
	var price = {$t[price]};
	var mina = {$t[minamount]};
	var maxa = {$t[amount]};
	{if $module == 'mall'}
	function get_price() {
		var number = $('#number').val();
		var price = {$t[price]};
		var price1 = parseInt(price)*number;
		return price1;
	}
	// function get_fee() {
	// 	var es = $('#express').html();
	// 	var number = parseInt($('#number').val());
	// 	if(es.indexOf('data--1') != -1) {
	// 		if(parseFloat(get_price()*number) >= parseFloat($('#fee_start_1').val())) {
	// 			$('#express').val(-1);
	// 		} else {
	// 			if(es.indexOf('data-0') != -1) {
	// 				$('#express').val(0);
	// 			} else if(es.indexOf('data-2') != -1) {
	// 				$('#express').val(2);
	// 			} else if(es.indexOf('data-3') != -1) {
	// 				$('#express').val(3);
	// 			}
	// 		}
	// 	}
	// 	var k = $('#express').val();
	// 	return k > 0 ? parseFloat($('#fee_start_'+k).val()) + parseFloat($('#fee_step_'+k).val())*(number-1) : 0.00;
	// }
	{/if}
	function alter(t) {
		var number = parseInt($('#number').val());
		if(t == '+') {
			$('#number').val(number+1);
			$('#goods_num').html(number+1);
		} else {
			$('#number').val(number-1);
			$('#goods_num').html(number-1);
		}
		calculate();
	}
	function calculate() {
		var number = parseInt($('#number').val());
		if(mina && number < mina) number = mina;
		if(maxa && number > maxa) number = maxa;
		if(number < 1) number = 1;
		$('#number').val(number);
	{if $module == 'mall'}
		price = get_price();
		$('#price').html(price);
	{/if}
		var money = price;
	{if $module == 'mall'}
		// fee = get_fee();
		// $('#fee').html('{$DT[money_sign]}'+fee.toFixed(2));
		// money += fee;
	{/if}
		$('#total').html((parseInt(money)+parseInt($('#mail_money').html())).toFixed(2));
	}
	function Dpurchase() {
		{if !$need_addr}
		if(!$('#mobile').val().match(/^1[3|4|5|7|8]{1}[0-9]{9}$/)) {
			alert('请填写正确的手机号码');
			return false;
		}
		{/if}
		$.post('purchase.php', $('#purchase-form').serialize(), function(data) {
			if(data.indexOf('ok|') != -1) {
				alert('订单创建成功，请尽快支付');
				id = data.substr(3);
				// setTimeout(function() {
				// 	Dsheet('<a href="{$MURL}{$order_name}.php?action=update&step=detail&itemid='+id+'" rel="external"><span>查看订单</span></a>|<a href="{$MURL}{$order_name}.php?action=update&step=pay&itemid='+id+'" rel="external"><span>支付订单</span></a>|<a href="index.php?moduleid={$moduleid}"><span>继续购物</span></a>');
				// }, 1000);
				setTimeout(function() {
					window.location.href = '{$MURL}{$order_name}.php?mobile=1&action=update&step=pay&itemid='+id;
				}, 1000);
			} else if(data == 'mobile') {
				alert('请填写正确的手机号码');
			} else {
				alert('订单创建失败，请重试');
				setTimeout(function() {
					window.location.reload();
				}, 1000);

			}
		});
	}
	$(document).on('pageinit', function(event) {
		$('input').on('blur', function(){window.scrollTo(0,0);});
		$('#number').on('blur', function(){calculate();});
		calculate();
	});
</script>
</body>
</html>